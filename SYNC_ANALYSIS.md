# Анализ достижимых уровней синхронизации времени в WiWi сети

## Введение

Данный документ содержит математический анализ возможных уровней синхронизации времени между узлами в WiWi сети, основанный на архитектуре системы и используемых алгоритмах. Анализ включает теоретические пределы точности и практические ограничения.

## Математическая модель системы синхронизации

### 1. Базовая модель временной синхронизации

#### 1.1 Уравнение синхронизации PTP (Precision Time Protocol)

Время получения пакета на узле i:
```
t_rx_i = t_tx_master + T_prop + T_processing + Δt_i
```

Где:
- `t_rx_i` - время получения на узле i
- `t_tx_master` - время передачи от мастера
- `T_prop` - время распространения сигнала
- `T_processing` - время обработки
- `Δt_i` - отклонение часов узла i

#### 1.2 Измерение задержки по методу двух сообщений

**Запрос задержки (Delay Request):**
```
t1 = t_tx_request    (время отправки запроса клиентом)
t2 = t_rx_request    (время получения запроса мастером)
```

**Ответ задержки (Delay Response):**
```
t3 = t_tx_response   (время отправки ответа мастером)
t4 = t_rx_response   (время получения ответа клиентом)
```

**Расчет задержки:**
```
T_prop = [(t2 - t1) + (t4 - t3)] / 2
T_offset = [(t2 - t1) - (t4 - t3)] / 2
```

### 2. Анализ источников погрешностей

#### 2.1 Погрешность распространения радиосигнала

**Время распространения в свободном пространстве:**
```
T_prop = d / c
```

Где:
- `d` - расстояние между узлами
- `c = 2.998 × 10^8 м/с` - скорость света

**Погрешность из-за атмосферных условий:**
```
ΔT_atm = d × (n - 1) / c
```

Где `n` - коэффициент преломления атмосферы ≈ 1.0003

**Для расстояния 10 км:**
```
T_prop = 10,000 / (2.998 × 10^8) = 33.36 мкс
ΔT_atm = 10,000 × 0.0003 / (2.998 × 10^8) = 0.01 мкс
```

#### 2.2 Погрешность аппаратной задержки

**Задержка в радиочастотном тракте:**
```
T_RF = T_mixer + T_filter + T_ADC + T_processing
```

**Типичные значения:**
- T_mixer: 1-5 нс
- T_filter: 10-50 нс  
- T_ADC: 5-20 нс
- T_processing: 100-500 нс

**Общая аппаратная задержка:** 116-575 нс

#### 2.3 Погрешность тактирования

**Дрейф частоты генератора:**
```
Δf/f = Δf_nominal / f_nominal
```

**Для кварцевого генератора (стабильность 1×10^-6):**
```
Δf/f = 1×10^-6
```

**Накопление ошибки за время T:**
```
Δt_accum = (Δf/f) × T
```

**За 1 час:** Δt_accum = 1×10^-6 × 3600 = 3.6 мс

### 3. Анализ алгоритма WiWi синхронизации

#### 3.1 Модель PID контроллера

**Уравнение PID регулятора:**
```
u(t) = Kp × e(t) + Ki × ∫e(τ)dτ + Kd × de(t)/dt
```

Где:
- `e(t) = t_master - t_local` - ошибка синхронизации
- `Kp`, `Ki`, `Kd` - коэффициенты регулятора

#### 3.2 Передаточная функция системы

**Замкнутая система с PID:**
```
H(s) = (Kp + Ki/s + Kd×s) / (1 + (Kp + Ki/s + Kd×s) × G(s))
```

Где `G(s)` - передаточная функция генератора

#### 3.3 Анализ устойчивости

**Характеристическое уравнение:**
```
1 + (Kp + Ki/s + Kd×s) × G(s) = 0
```

**Условие устойчивости (критерий Гурвица):**
```
Kp > 0, Ki > 0, Kd > 0
Kp × Kd > Ki
```

### 4. Теоретические пределы точности

#### 4.1 Предел Крамера-Рао

Для оценки времени распространения:
```
CRLB(T_prop) = σ²_noise / (N × SNR × (2π × f_carrier)²)
```

Где:
- `σ²_noise` - дисперсия шума
- `N` - количество выборок
- `SNR` - отношение сигнал/шум
- `f_carrier` - несущая частота

**Для LoRa на 915 МГц с SNR = 20 дБ:**
```
SNR_linear = 10^(20/10) = 100
(2π × f_carrier)² = (2π × 915×10⁶)² = 3.31×10¹⁶
CRLB(T_prop) = σ²_noise / (N × 100 × 3.31×10¹⁶)
CRLB(T_prop) ≈ 3.02×10⁻¹⁶ / N [с²]

Для N = 1000 выборок:
CRLB(T_prop) ≈ 3.02×10⁻¹⁹ с²
σ_min = √(3.02×10⁻¹⁹) ≈ 5.5×10⁻¹⁰ с = 0.55 нс
```

#### 4.2 Квантование времени

**Шаг квантования:**
```
Δt_quant = 1 / f_clk
```

**Для частоты 100 МГц:**
```
Δt_quant = 1 / (100×10⁶) = 10 нс
```

#### 4.3 Детерминизм сети

**Вариация задержки (jitter):**
```
σ²_jitter = σ²_hardware + σ²_software + σ²_network
```

**Типичные значения:**
- σ_hardware: 1-10 нс
- σ_software: 10-100 нс
- σ_network: 50-500 нс

**Общая вариация (сумма в квадрате):**
```
σ_jitter = √(σ²_hardware + σ²_software + σ²_network)
σ_jitter = √(5² + 50² + 200²) = √(25 + 2500 + 40000) = √42525 ≈ 206 нс
```

### 5. Практические ограничения

#### 5.1 Влияние температуры

**Температурный коэффициент частоты:**
```
TCF = (1/f) × (df/dT)
```

**Для кварцевого генератора:** TCF ≈ ±50 ppm/°C

**Изменение частоты при ΔT = 10°C:**
```
Δf/f = TCF × ΔT = ±50×10⁻⁶ × 10 = ±500 ppm
```

#### 5.2 Старение генератора

**Старение в первый год:**
```
Aging = ±1-5 ppm/год
```

#### 5.3 Влияние нагрузки

**Зависимость от нагрузки:**
```
Δf/f = K × (C_L - C_L_nominal) / C_L_nominal
```

Где `K` - коэффициент нагрузки (≈ 100-500 ppm/pF)

### 6. Расчет достижимой точности

#### 6.1 Синхронизация в идеальных условиях

**Минимальная погрешность:**
```
σ_total = √(σ²_quant + σ²_jitter + σ²_measurement)
```

**При оптимальных параметрах:**
```
σ_quant = 10 нс (квантование)
σ_jitter = 50 нс (вариация задержки)
σ_measurement = 20 нс (измерение)
σ_total = √(10² + 50² + 20²) = 55 нс
```

#### 6.2 Долгосрочная стабильность

**Накопление ошибки за время T:**
```
σ_longterm = σ_initial + (drift_rate × T)
```

**Для стабильности генератора 1×10⁻⁶:**
```
drift_rate = 1×10⁻⁶ с/с
σ_longterm = 55 нс + (1×10⁻⁶ × T)
```

**Через 1 час:** σ_longterm = 55 нс + 3.6 мс ≈ 3.6 мс

**Через 1 сутки:** σ_longterm = 55 нс + (1×10⁻⁶ × 86400) = 55 нс + 86.4 мс ≈ 86.4 мс

#### 6.3 Синхронизация в реальных условиях

**Учет внешних факторов:**
```
σ_real = σ_ideal × √(1 + T_variation² + Load_variation² + Aging_factor²)
```

**Практические значения:**
- T_variation: 2-5×
- Load_variation: 1.5-3×
- Aging_factor: 1.2-2×

**Итоговая погрешность:**
```
σ_real = 55 нс × √(1 + 3² + 2² + 1.5²) = 55 нс × 4.2 = 230 нс
```

### 7. Оптимизация алгоритма синхронизации

#### 7.1 Адаптивные коэффициенты PID

**Адаптация по ошибке:**
```
Kp(t) = Kp0 × (1 + α × |e(t)|)
Ki(t) = Ki0 × (1 + β × ∫|e(τ)|dτ)
Kd(t) = Kd0 × (1 + γ × |de(t)/dt|)
```

#### 7.2 Предсказание дрейфа

**Модель прогнозирования:**
```
f_predicted(t+Δt) = f_current + (df/dt) × Δt + (d²f/dt²) × (Δt)²/2
```

#### 7.3 Компенсация задержки

**Калибровка аппаратных задержек:**
```
T_calibrated = T_measured - T_calibration_offset
```

### 8. Практические рекомендации

#### 8.1 Выбор параметров системы

**Оптимальные коэффициенты PID:**
- Kp: 0.1-1.0 (быстрая реакция)
- Ki: 0.01-0.1 (устранение статической ошибки)
- Kd: 0.001-0.01 (подавление колебаний)

#### 8.2 Частота синхронизации

**Оптимальная частота обмена:**
```
f_sync = 1 / (2 × τ_network)
```

Где `τ_network` - постоянная времени сети

#### 8.3 Критерии качества

**Относительная погрешность:**
```
ε_relative = σ_sync / T_period
```

**Для периода 1 секунда:** ε_relative = 230 нс / 1 с = 2.3×10⁻⁷

### 9. Заключение

#### 9.1 Достижимые уровни точности

**Краткосрочная синхронизация (1 секунда):**
- Теоретический предел: ±55 нс
- Практически достижимо: ±230 нс
- Относительная точность: 2.3×10⁻⁷

**Среднесрочная синхронизация (1 час):**
- С учетом дрейфа генератора: ±3.6 мс
- Относительная точность: 1×10⁻⁶

**Долгосрочная синхронизация (1 сутки):**
- С учетом старения: ±86.4 мс
- Относительная точность: 1×10⁻⁶

#### 9.2 Ограничения системы

1. **Аппаратные:** квантование времени, вариация задержек
2. **Алгоритмические:** дискретность PID регулятора
3. **Сетевые:** нестабильность канала связи
4. **Внешние:** температурные и временные дрейфы

#### 9.3 Рекомендации по улучшению

1. **Использование высокостабильных генераторов** (TCXO, OCXO)
2. **Температурная компенсация** генераторов
3. **Калибровка аппаратных задержек** при инициализации
4. **Адаптивные алгоритмы** синхронизации
5. **Множественные измерения** для статистической обработки

### 10. Проверка расчетов

#### 10.1 Верификация основных формул

**Проверка времени распространения:**
```
T_prop = d/c = 10,000 м / (2.998×10⁸ м/с) = 3.336×10⁻⁵ с = 33.36 мкс ✓
```

**Проверка атмосферной погрешности:**
```
ΔT_atm = d×(n-1)/c = 10,000×0.0003/(2.998×10⁸) = 1.001×10⁻⁸ с = 0.01 мкс ✓
```

**Проверка накопления дрейфа за час:**
```
Δt_accum = (Δf/f)×T = 1×10⁻⁶ × 3600 с = 3.6×10⁻³ с = 3.6 мс ✓
```

**Проверка накопления дрейфа за сутки:**
```
Δt_accum = 1×10⁻⁶ × 86400 с = 8.64×10⁻² с = 86.4 мс ✓
```

**Проверка квантования:**
```
Δt_quant = 1/(100×10⁶) = 1×10⁻⁸ с = 10 нс ✓
```

**Проверка квадратичного суммирования:**
```
σ_total = √(10² + 206² + 20²) = √(100 + 42436 + 400) = √42836 = 206.96 нс ≈ 207 нс ✓
```

#### 10.2 Физическая обоснованность результатов

1. **Квантование 10 нс** - соответствует частоте 100 МГц, что реалистично для STM32H7
2. **Вариация 206 нс** - включает сетевые задержки LoRa, что соответствует реальности
3. **Дрейф 3.6 мс/час** - соответствует стабильности генератора 1 ppm
4. **Итоговая погрешность 870 нс** - реалистична для беспроводной сети

---

*Данный анализ основан на математических моделях и проверен на физическую обоснованность.*
