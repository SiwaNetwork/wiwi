# Архитектура системы RANDOM_SYNC_2017MHZ_V2

## 1. Обзор архитектуры

Система RANDOM_SYNC_2017MHZ_V2 представляет собой гибридную архитектуру, сочетающую проверенную платформу WiWi с современным радиотрансивером AD9361 для достижения высокой точности синхронизации на частоте 2017 МГц.

### 1.1 Принцип работы
- **Master модуль** получает точное время от GNSS приемника
- Генерирует PTP пакеты синхронизации
- Передает их по радиоканалу 2017 МГц с использованием AD9361
- **Slave модули** принимают PTP пакеты и ретранслируют их нижестоящим устройствам

## 2. Структурная схема

```
┌─────────────────────────────────────────────────────────────────┐
│                    Master/Slave модуль                          │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────┐ │
│  │   GNSS      │  │   STM32H7   │  │   AD9361    │  │  SFP    │ │
│  │  Антенна    │  │   Control   │  │   Radio     │  │  Ports  │ │
│  │  (SMA)      │◄►│   + PTP     │◄►│   Transc.   │◄►│ (3x)    │ │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────┘ │
│           │              │                 │              │       │
│           ▼              ▼                 ▼              ▼       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────┐ │
│  │   OCXO      │  │    ECP5     │  │   Ethernet  │  │ Power   │ │
│  │  ±0.05ppm   │  │    FPGA     │  │   + PTP     │  │ Supply  │ │
│  │  Generator  │◄►│   I/Q Proc  │◄►│   Hardware  │◄►│ -48V DC │ │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 3. Компоненты системы

### 3.1 Микроконтроллер STM32H747XIHx
- **Процессор:** ARM Cortex-M7 480 МГц
- **Память:** 2 МБ Flash, 1 МБ SRAM
- **Интерфейсы:** USB, Ethernet, SPI, I2C, UART
- **ОС:** FreeRTOS с поддержкой PTP стека

### 3.2 Радиотрансивер AD9361BBCZ
- **Диапазон частот:** 70 МГц - 6 ГГц
- **Полоса пропускания:** До 56 МГц
- **Разрядность АЦП/ЦАП:** 12 бит
- **Интерфейс:** 2x SPI для данных + SPI для управления
- **Особенности:** Встроенные PLL, фильтры, AGC

### 3.3 FPGA Lattice ECP5-5G
- **Логика:** 84K LUT, 4.5 Мбит RAM
- **Интерфейсы:** LVDS для I/Q данных, SPI для управления
- **Функции:** Цифровая обработка сигналов, фильтрация, буферизация

### 3.4 Генератор частоты OCXO
- **Стабильность:** ±0.05 ppm
- **Выходная частота:** 10 МГц
- **Температурный диапазон:** -40°C до +85°C
- **Питание:** 3.3V/5V

### 3.5 GNSS приемник
- **Системы:** GPS, GLONASS, Galileo, BeiDou
- **Интерфейс:** UART NMEA + 1 PPS выход
- **Антенный вход:** SMA 50 Ом
- **Чувствительность:** -165 дБм

## 4. Интерфейсы и протоколы

### 4.1 Радиоинтерфейс 2017 МГц
```
AD9361 TX ─┬─ HPA (усилитель мощности) ── Антенна
AD9361 RX ─┴─ LNA (усилитель низкого шума) ─ Антенна
```

- **Модуляция:** QPSK, 16-QAM, 64-QAM (адаптивная)
- **Кодирование:** LDPC, Turbo (адаптивное)
- **Режим:** TDD (Time Division Duplex)

### 4.2 PTP интерфейсы (SFP порты)
```
┌─────────┐  ┌─────────┐  ┌─────────┐
│  SFP 1  │  │  SFP 2  │  │  SFP 3  │
│ (Input) │  │ (Output)│  │ (Output)│
└─────────┘  └─────────┘  └─────────┘
      │           │           │
      ▼           ▼           ▼
Ethernet PHY ─── PTP Hardware ─── STM32H7
```

- **Протокол:** PTP IEEE 1588-2008 + G.8275.1
- **Hardware timestamping:** Да (Ethernet PHY уровень)
- **Режим:** Boundary Clock

### 4.3 Системные интерфейсы
- **Управление:** Ethernet RJ-45 + REST API
- **Отладка:** USB UART + JTAG
- **Мониторинг:** SNMP + syslog

## 5. Сигнальные пути

### 5.1 Путь синхронизации (Master → Slave)
```
GNSS Антенна ──► GNSS RX ──► STM32H7 ──► PTP Engine ──►
                                                       ├─► Ethernet (SFP) ──► Slave
                                                       └─► AD9361 TX ──► Radio ──► Slave
```

### 5.2 Путь данных (Slave ретрансляция)
```
Radio RX ──► AD9361 RX ──► FPGA ──► STM32H7 ──► PTP Engine ──►
                                                             ├─► Ethernet (SFP) ──► Downstream
                                                             └─► AD9361 TX ──► Radio ──► Downstream
```

### 5.3 Путь тактирования
```
OCXO ──► Clock Distribution ──► STM32H7 ──► FPGA ──► AD9361
                                │         │        │
                                ▼         ▼        ▼
                           Ethernet    I/Q Data   Reference
                           PHY       Processing   Clock
```

## 6. Программная архитектура

### 6.1 Уровни программного обеспечения

```
┌─────────────────────────────────────────────────────────┐
│                    Прикладной уровень                    │
├─────────────────────────────────────────────────────────┤
│  REST API │ SNMP │ PTP Application │ Sync Algorithms   │
├─────────────────────────────────────────────────────────┤
│                    Транспортный уровень                   │
├─────────────────────────────────────────────────────────┤
│  UDP/IP │ PTP Protocol │ Radio Control │ FPGA Interface │
├─────────────────────────────────────────────────────────┤
│                     Аппаратный уровень                    │
├─────────────────────────────────────────────────────────┤
│  STM32H7 HAL │ FPGA Drivers │ AD9361 Drivers │ PHY Drivers │
└─────────────────────────────────────────────────────────┘
```

### 6.2 Ключевые модули

#### PTP Engine (`ptp_engine.c`)
```c
struct ptp_state {
    ptp_clock_t master_clock;
    ptp_port_t ports[3];  // 3 SFP порта
    sync_algorithm_t sync_algo;
    hardware_timestamp_t hw_ts;
};
```

#### Radio Controller (`radio_controller.c`)
```c
struct radio_config {
    ad9361_dev_t *ad9361;
    uint64_t frequency;  // 2017000000 Hz
    uint32_t bandwidth;  // 20 MHz
    modulation_t modulation;
};
```

#### FPGA Interface (`fpga_interface.c`)
```c
struct fpga_config {
    ecp5_dev_t *fpga;
    iq_buffer_t iq_tx_buffer;
    iq_buffer_t iq_rx_buffer;
    sync_fifo_t sync_fifo;
};
```

## 7. Электропитание

### 7.1 Структура питания
```
-48V DC Input ─┬─► Protection Circuit ─┬─► DC-DC 48V→12V ─┬─► DC-DC 12V→5V ───► Digital 5V
                │                       │                  ├─► DC-DC 12V→3.3V ─► Digital 3.3V
                │                       │                  └─► LDO 5V→3.3V ───► Analog 3.3V
                │                       │
                └─► DC-DC 48V→5V ──────┴─► RF Power 5V ───► AD9361, Amplifiers
```

### 7.2 Требования к питанию
- **Входное напряжение:** -48V DC (-36V до -57V)
- **Потребляемая мощность:** До 25 Вт (Master), 20 Вт (Slave)
- **КПД блока питания:** >85%
- **Защита:** От переполюсовки, КЗ, перегрева

## 8. Механическая конструкция

### 8.1 Габаритные размеры
- **Форм-фактор:** 1U 19" rackmount
- **Размеры:** 482×44×300 мм (Ш×В×Г)
- **Масса:** Не более 3 кг

### 8.2 Разъемы на передней панели
```
┌─────────────────────────────────────────────────────────┐
│  ANT  │  GNSS  │  USB  │  ETH  │  SFP1  │  SFP2  │  SFP3  │
│ (SMA) │ (SMA)  │ (USB) │ (RJ45)│ (SFP) │ (SFP)  │ (SFP)  │
└─────────────────────────────────────────────────────────┘
```

### 8.3 Разъемы на задней панели
```
┌─────────────────────────────────────────────────────────┐
│  -48V DC  │  GND  │  ALARM  │  STATUS  │  DEBUG  │  FAN  │
│  (Power)  │      │  (Dry)  │   (LED)  │  (UART) │      │
└─────────────────────────────────────────────────────────┘
```

## 9. Надежность и безопасность

### 9.1 Температурный режим
- **Рабочий диапазон:** -40°C до +55°C
- **Хранение:** -50°C до +70°C
- **Охлаждение:** Активное (вентиляторы) + пассивное (радиаторы)

### 9.2 Электромагнитная совместимость
- **ЭМС:** Соответствие ГОСТ Р 51317.4.5-99
- **Грозозащита:** Уровень 4 (IEC 61000-4-5)
- **Помехоустойчивость:** Уровень 3 (IEC 61000-4-3)

### 9.3 Безопасность
- **Электробезопасность:** Класс III (SELV)
- **Пожаробезопасность:** UL94-V0 материалы
- **Защита от несанкционированного доступа:** Пломбировка

---

*Архитектура создана: Январь 2025*
*Версия: 1.0*
